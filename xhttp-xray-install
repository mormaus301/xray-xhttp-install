#!/bin/bash
echo "–ë—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Vless —Å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º XHTTP"
sleep 3
apt update
apt install qrencode curl jq -y

# –í–∫–ª—é—á–∞–µ–º bbr
bbr=$(sysctl -a | grep net.ipv4.tcp_congestion_control)
if [ "$bbr" = "net.ipv4.tcp_congestion_control = bbr" ]; then
echo "bbr —É–∂–µ –≤–∫–ª—é—á–µ–Ω"
else
echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
sysctl -p
echo "bbr –≤–∫–ª—é—á–µ–Ω"
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–¥—Ä–æ Xray
bash -c "$(curl -4 -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install
[ -f /usr/local/etc/xray/.keys ] && rm /usr/local/etc/xray/.keys
touch /usr/local/etc/xray/.keys
echo "shortsid: $(openssl rand -hex 8)" >> /usr/local/etc/xray/.keys
echo "uuid: $(xray uuid)" >> /usr/local/etc/xray/.keys
xray x25519 >> /usr/local/etc/xray/.keys

export uuid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/uuid/ {print $2}')
export privatkey=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/PrivateKey/ {print $2}')
export shortsid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è –¥–ª—è Shadowsocks
ss_password=$(openssl rand -base64 32)

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray
touch /usr/local/etc/xray/config.json
cat << EOF > /usr/local/etc/xray/config.json
{
    "log": {
        "loglevel": "warning"
    },
    "routing": {
        "domainStrategy": "IPIfNonMatch",
        "rules": [
            {
                "type": "field",
                "domain": [
                    "geosite:category-ads-all"
                ],
                "outboundTag": "block"
            },
            {
                "type": "field",
                "ip": [
                    "geoip:cn"
                ],
                "outboundTag": "block"
            }
        ]
    },
    "inbounds": [
        {
            "listen": "0.0.0.0",
            "port": 443,
            "protocol": "vless",
            "settings": {
                "clients": [
                    {
                        "email": "main",
                        "id": "$uuid",
                        "flow": ""
                    }
                ],
                "decryption": "none"
            },
            "streamSettings": {
                "network": "xhttp",
                "xhttpSettings": {
                    "path": "/",
                    "mode": "packet-up"
                },
                "security": "reality",
                "realitySettings": {
                    "show": false,
                    "target": "www.habr.com:443",
                    "serverNames": [
                        "www.habr.com"
                    ],
                    "privateKey": "$privatkey",
                    "minClientVer": "",
                    "maxClientVer": "",
                    "maxTimeDiff": 0,
                    "shortIds": [
                        "$shortsid"
                    ]
                }
            },
            "sniffing": {
                "enabled": true,
                "destOverride": [
                    "http",
                    "tls",
                    "quic",
                    "fakedns"
                ],
                "metadataOnly": false,
                "routeOnly": false
            }
        },
        {
              "listen": "0.0.0.0",
              "port": 8080,
              "protocol": "shadowsocks",
              "settings": {
                "method": "2022-blake3-aes-256-gcm",
                "password": "$ss_password",
                "network": "tcp,udp",
                "clients": [],
                "ivCheck": false
              },
              "sniffing": {
                "enabled": true,
                "destOverride": [
                  "http",
                  "tls",
                  "quic",
                  "fakedns"
                ],
                "metadataOnly": false,
                "routeOnly": false
          }
        }
    ],
    "outbounds": [
        {
            "protocol": "freedom",
            "tag": "direct"
        },
        {
            "protocol": "blackhole",
            "tag": "block"
        }
    ],
    "policy": {
        "levels": {
            "0": {
                "handshake": 3,
                "connIdle": 180
            }
        }
    }
}
EOF

# –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
touch /usr/local/bin/userlist
cat << 'EOF' > /usr/local/bin/userlist
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' "/usr/local/etc/xray/config.json"))

if [[ ${#emails[@]} -eq 0 ]]; then
    echo "–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—É—Å—Ç"
    exit 1
fi

echo "–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤:"
for i in "${!emails[@]}"; do
    echo "$((i+1)). ${emails[$i]}"
done
EOF
chmod +x /usr/local/bin/userlist

# –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –¥–ª—è —Å—Å—ã–ª–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
touch /usr/local/bin/mainuser
cat << EOF > /usr/local/bin/mainuser
#!/bin/bash
# –°–±–æ—Ä –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ
port_vless=\$(jq -r '.inbounds[0].port' /usr/local/etc/xray/config.json)
uuid=\$(jq -r '.inbounds[0].settings.clients[0].id' /usr/local/etc/xray/config.json)
mode=\$(jq -r '.inbounds[0].streamSettings.xhttpSettings.mode' /usr/local/etc/xray/config.json)
sni=\$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
pbk=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/Password/ {print $2}')
sid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')
ip=$(timeout 3 curl -4 -s icanhazip.com)

port_ss=\$(jq -r '.inbounds[1].port' /usr/local/etc/xray/config.json)
pass=\$(jq -r '.inbounds[1].settings.password' /usr/local/etc/xray/config.json)
method=\$(jq -r '.inbounds[1].settings.method' /usr/local/etc/xray/config.json)

# –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–∫–∏ "–º–µ—Ç–æ–¥:–ø–∞—Ä–æ–ª—å" –≤ Base64 –±–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ (-w0)
userinfo_base64=\$(echo -n "\$method_ss:\$pass_ss" | base64 -w0)

# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Å—ã–ª–∫–∏
ss_link="ss://\$userinfo_base64@\$ip:\$port_ss#SS-2022"

vless_link="vless://\$uuid@\$ip:\$port_vless?security=reality&path=%2F&host=&mode=\$mode&sni=\$sni&fp=firefox&pbk=\$pbk&sid=\$sid&spx=%2F&type=xhttp&encryption=none#VLESS-XHTTP"

# ss_link="ss://\$method:\$pass@\$ip:\$port_ss#SS-2022"

# –í—ã–≤–æ–¥ –∏—Ç–æ–≥–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
echo -e "\n\e[1;33m==================================================\e[0m"
echo -e "\e[1;32m      XRAY INSTALLATION COMPLETE üé≠\e[0m"
echo -e "\e[1;33m==================================================\e[0m"

echo -e "\n\e[1;34m[+] VLESS XHTTP REALITY:\e[0m"
echo -e "\e[36m\$vless_link\e[0m"

echo -e "\n\e[1;34m[+] SHADOWSOCKS 2022:\e[0m"
echo -e "\e[36m\$ss_link\e[0m"

echo -e "\n\e[1;33m==================================================\e[0m"
echo "QR-–∫–æ–¥ –¥–ª—è VLESS:"
echo "\$vless_link" | qrencode -t ansiutf8
echo -e "\e[1;33m==========================================================================\e[0m"
echo "QR-–∫–æ–¥ –¥–ª—è Shadowsocks:"
echo "\$ss_link" | qrencode -t ansiutf8
echo -e "\e[1;33m==========================================================================\e[0m"

EOF
chmod +x /usr/local/bin/mainuser

# –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
touch /usr/local/bin/newuser
cat << 'EOF' > /usr/local/bin/newuser
#!/bin/bash
read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (email): " email

    if [[ -z "$email" || "$email" == *" "* ]]; then
    echo "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    exit 1
    fi
user_json=$(jq --arg email "$email" '.inbounds[0].settings.clients[] | select(.email == $email)' /usr/local/etc/xray/config.json)

if [[ -z "$user_json" ]]; then
uuid=$(xray uuid)
jq --arg email "$email" --arg uuid "$uuid" '.inbounds[0].settings.clients += [{"email": $email, "id": $uuid, "flow": ""}]' /usr/local/etc/xray/config.json > tmp.json && mv tmp.json /usr/local/etc/xray/config.json
systemctl restart xray
index=$(jq --arg email "$email" '.inbounds[0].settings.clients | to_entries[] | select(.value.email == $email) | .key'  /usr/local/etc/xray/config.json)
#port=$(jq -r '.inbounds[0].port' /usr/local/etc/xray/config.json)
#uuid=$(jq --argjson index "$index" -r '.inbounds[0].settings.clients[$index].id' /usr/local/etc/xray/config.json)
#pbk=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/Password/ {print $2}')
#sid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')
username=$(jq --argjson index "$index" -r '.inbounds[0].settings.clients[$index].email' /usr/local/etc/xray/config.json)
sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
ip=$(timeout 3 curl -4 -s icanhazip.com)
link="vless://$uuid@$ip:$port?security=reality&path=%2F&host=&mode=auto&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&spx=%2F&type=xhttp&encryption=none#vless-$ip"
ss_link="ss://2022-blake3-aes-256-gcm:${ss_password}@\$ip:8080#ss-$ip"

# –ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ –∏—Ç–æ–≥–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
echo -e "\n\e[1;33m==================================================\e[0m"
echo -e "\e[1;32m      XRAY \e[0m"
echo -e "\e[1;33m==================================================\e[0m"

echo -e "\n\e[1;34m[+] VLESS XHTTP REALITY:\e[0m"
echo -e "\e[36m\$link\e[0m"

echo -e "\n\e[1;34m[+] SHADOWSOCKS 2022:\e[0m"
echo -e "\e[36m\$ss_link\e[0m"

echo -e "\n\e[1;33m==================================================\e[0m"
echo "QR-–∫–æ–¥ –¥–ª—è VLESS:"
echo "\$link" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/mainuser

systemctl restart xray

echo "Xray-core —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
mainuser

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
touch $HOME/help
cat << 'EOF' > $HOME/help

–ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ Xray:

    mainuser - –≤—ã–≤–æ–¥–∏—Ç —Å—Å—ã–ª–∫—É –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    newuser - —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    rmuser - —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    sharelink - –≤—ã–≤–æ–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞—Ç—å –¥–ª—è –Ω–∏—Ö —Å—Å—ã–ª–∫–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    userlist - –≤—ã–≤–æ–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤



–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É:

    /usr/local/etc/xray/config.json

–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —è–¥—Ä–∞ Xray:

    systemctl restart xray

EOF
